{"ast":null,"code":"\"use strict\";\n\nvar _createForOfIteratorHelper = require(\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/createForOfIteratorHelper.js\").default;\nvar _regeneratorRuntime = require(\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/regeneratorRuntime.js\").default;\nvar _classCallCheck = require(\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.HWProvider = void 0;\nvar hw_transport_webusb_1 = __importDefault(require(\"@ledgerhq/hw-transport-webusb\"));\nvar hw_transport_webhid_1 = __importDefault(require(\"@ledgerhq/hw-transport-webhid\"));\nvar hw_transport_u2f_1 = __importDefault(require(\"@ledgerhq/hw-transport-u2f\"));\n// @ts-ignore\nvar hw_app_elrond_1 = __importDefault(require(\"@elrondnetwork/hw-app-elrond\"));\nvar platform_1 = __importDefault(require(\"platform\"));\nvar versioning_1 = require(\"./versioning\");\nvar constants_1 = require(\"./constants\");\nvar signature_1 = require(\"./signature\");\nvar userAddress_1 = require(\"./userAddress\");\nvar transactionVersion_1 = require(\"./transactionVersion\");\nvar transactionOptions_1 = require(\"./transactionOptions\");\nvar errors_1 = require(\"./errors\");\nvar HWProvider = /*#__PURE__*/function () {\n  function HWProvider() {\n    _classCallCheck(this, HWProvider);\n    this.addressIndex = 0;\n  }\n  /**\n   * Creates transport and initialises ledger app.\n   */\n  _createClass(HWProvider, [{\n    key: \"init\",\n    value: function init() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var transport;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                _context.next = 3;\n                return this.getTransport();\n              case 3:\n                transport = _context.sent;\n                this.hwApp = new hw_app_elrond_1.default(transport);\n                return _context.abrupt(\"return\", true);\n              case 8:\n                _context.prev = 8;\n                _context.t0 = _context[\"catch\"](0);\n                return _context.abrupt(\"return\", false);\n              case 11:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[0, 8]]);\n      }));\n    }\n  }, {\n    key: \"getTransport\",\n    value: function getTransport() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        var webUSBSupported, webHIDSupported;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return hw_transport_webusb_1.default.isSupported();\n              case 2:\n                webUSBSupported = _context2.sent;\n                webUSBSupported = webUSBSupported && platform_1.default.name !== \"Opera\";\n                if (!webUSBSupported) {\n                  _context2.next = 8;\n                  break;\n                }\n                _context2.next = 7;\n                return hw_transport_webusb_1.default.create();\n              case 7:\n                return _context2.abrupt(\"return\", _context2.sent);\n              case 8:\n                _context2.next = 10;\n                return hw_transport_webhid_1.default.isSupported();\n              case 10:\n                webHIDSupported = _context2.sent;\n                if (!webHIDSupported) {\n                  _context2.next = 15;\n                  break;\n                }\n                _context2.next = 14;\n                return hw_transport_webhid_1.default.open(\"\");\n              case 14:\n                return _context2.abrupt(\"return\", _context2.sent);\n              case 15:\n                _context2.next = 17;\n                return hw_transport_u2f_1.default.create();\n              case 17:\n                return _context2.abrupt(\"return\", _context2.sent);\n              case 18:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n    }\n    /**\n     * Returns true if init() was previously called successfully\n     */\n  }, {\n    key: \"isInitialized\",\n    value: function isInitialized() {\n      return !!this.hwApp;\n    }\n    /**\n     * Mocked function, returns isInitialized as an async function\n     */\n  }, {\n    key: \"isConnected\",\n    value: function isConnected() {\n      var _this = this;\n      return new Promise(function (resolve, _) {\n        return resolve(_this.isInitialized());\n      });\n    }\n    /**\n     * Performs a login request by setting the selected index in Ledger and returning that address\n     */\n  }, {\n    key: \"login\",\n    value: function login() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n        addressIndex: 0\n      };\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n        var _yield$this$hwApp$get, address;\n        return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context3.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                _context3.next = 4;\n                return this.setAddressIndex(options.addressIndex);\n              case 4:\n                _context3.next = 6;\n                return this.hwApp.getAddress(0, options.addressIndex, true);\n              case 6:\n                _yield$this$hwApp$get = _context3.sent;\n                address = _yield$this$hwApp$get.address;\n                return _context3.abrupt(\"return\", address);\n              case 9:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n    }\n  }, {\n    key: \"setAddressIndex\",\n    value: function setAddressIndex(addressIndex) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context4.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                this.addressIndex = addressIndex;\n                _context4.next = 5;\n                return this.hwApp.setAddress(0, addressIndex);\n              case 5:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n    }\n  }, {\n    key: \"getAccounts\",\n    value: function getAccounts() {\n      var page = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n      var pageSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 10;\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {\n        var addresses, startIndex, index, _yield$this$hwApp$get2, address;\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context5.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                addresses = [];\n                startIndex = page * pageSize;\n                index = startIndex;\n              case 5:\n                if (!(index < startIndex + pageSize)) {\n                  _context5.next = 14;\n                  break;\n                }\n                _context5.next = 8;\n                return this.hwApp.getAddress(0, index);\n              case 8:\n                _yield$this$hwApp$get2 = _context5.sent;\n                address = _yield$this$hwApp$get2.address;\n                addresses.push(address);\n              case 11:\n                index++;\n                _context5.next = 5;\n                break;\n              case 14:\n                return _context5.abrupt(\"return\", addresses);\n              case 15:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n    }\n    /**\n     * Mocks a logout request by returning true\n     */\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee6() {\n        return _regeneratorRuntime().wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context6.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                return _context6.abrupt(\"return\", true);\n              case 3:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n    }\n    /**\n     * Fetches current selected ledger address\n     */\n  }, {\n    key: \"getAddress\",\n    value: function getAddress() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee7() {\n        var _yield$this$hwApp$get3, address;\n        return _regeneratorRuntime().wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context7.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                _context7.next = 4;\n                return this.hwApp.getAddress(0, this.addressIndex);\n              case 4:\n                _yield$this$hwApp$get3 = _context7.sent;\n                address = _yield$this$hwApp$get3.address;\n                return _context7.abrupt(\"return\", address);\n              case 7:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n    }\n  }, {\n    key: \"signTransaction\",\n    value: function signTransaction(transaction) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee8() {\n        var currentAddressBech32, currentAddress, signUsingHash, serializedTransaction, serializedTransactionBuffer, signature;\n        return _regeneratorRuntime().wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context8.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                _context8.next = 4;\n                return this.getAddress();\n              case 4:\n                currentAddressBech32 = _context8.sent;\n                currentAddress = new userAddress_1.UserAddress(currentAddressBech32);\n                _context8.next = 8;\n                return this.shouldSignUsingHash();\n              case 8:\n                signUsingHash = _context8.sent;\n                if (signUsingHash) {\n                  transaction.options = transactionOptions_1.TransactionOptions.withTxHashSignOptions();\n                  transaction.version = transactionVersion_1.TransactionVersion.withTxHashSignVersion();\n                }\n                serializedTransaction = transaction.serializeForSigning(currentAddress);\n                serializedTransactionBuffer = Buffer.from(serializedTransaction);\n                _context8.next = 14;\n                return this.hwApp.signTransaction(serializedTransactionBuffer, signUsingHash);\n              case 14:\n                signature = _context8.sent;\n                transaction.applySignature(signature_1.Signature.fromHex(signature), currentAddress);\n                return _context8.abrupt(\"return\", transaction);\n              case 17:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n    }\n  }, {\n    key: \"signTransactions\",\n    value: function signTransactions(transactions) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee9() {\n        var _iterator, _step, tx;\n        return _regeneratorRuntime().wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                _iterator = _createForOfIteratorHelper(transactions);\n                _context9.prev = 1;\n                _iterator.s();\n              case 3:\n                if ((_step = _iterator.n()).done) {\n                  _context9.next = 9;\n                  break;\n                }\n                tx = _step.value;\n                _context9.next = 7;\n                return this.signTransaction(tx);\n              case 7:\n                _context9.next = 3;\n                break;\n              case 9:\n                _context9.next = 14;\n                break;\n              case 11:\n                _context9.prev = 11;\n                _context9.t0 = _context9[\"catch\"](1);\n                _iterator.e(_context9.t0);\n              case 14:\n                _context9.prev = 14;\n                _iterator.f();\n                return _context9.finish(14);\n              case 17:\n                return _context9.abrupt(\"return\", transactions);\n              case 18:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this, [[1, 11, 14, 17]]);\n      }));\n    }\n  }, {\n    key: \"signMessage\",\n    value: function signMessage(message) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee10() {\n        var serializedMessage, serializedMessageBuffer, signature;\n        return _regeneratorRuntime().wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context10.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                serializedMessage = message.serializeForSigningRaw();\n                serializedMessageBuffer = Buffer.from(serializedMessage);\n                _context10.next = 6;\n                return this.hwApp.signMessage(serializedMessageBuffer);\n              case 6:\n                signature = _context10.sent;\n                message.applySignature(signature_1.Signature.fromHex(signature));\n                return _context10.abrupt(\"return\", message);\n              case 9:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n    }\n  }, {\n    key: \"tokenLogin\",\n    value: function tokenLogin(options) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee11() {\n        var addressIndex, _yield$this$hwApp$get4, signature, address;\n        return _regeneratorRuntime().wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context11.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                addressIndex = options.addressIndex || 0;\n                _context11.next = 5;\n                return this.setAddressIndex(addressIndex);\n              case 5:\n                _context11.next = 7;\n                return this.hwApp.getAddressAndSignAuthToken(0, addressIndex, options.token);\n              case 7:\n                _yield$this$hwApp$get4 = _context11.sent;\n                signature = _yield$this$hwApp$get4.signature;\n                address = _yield$this$hwApp$get4.address;\n                return _context11.abrupt(\"return\", {\n                  signature: signature_1.Signature.fromHex(signature),\n                  address: address\n                });\n              case 11:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n    }\n  }, {\n    key: \"shouldSignUsingHash\",\n    value: function shouldSignUsingHash() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee12() {\n        var config, diff;\n        return _regeneratorRuntime().wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (this.hwApp) {\n                  _context12.next = 2;\n                  break;\n                }\n                throw new errors_1.ErrNotInitialized();\n              case 2:\n                _context12.next = 4;\n                return this.hwApp.getAppConfiguration();\n              case 4:\n                config = _context12.sent;\n                diff = versioning_1.compareVersions(config.version, constants_1.LEDGER_TX_HASH_SIGN_MIN_VERSION);\n                return _context12.abrupt(\"return\", diff >= 0);\n              case 7:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n    }\n  }]);\n  return HWProvider;\n}();\nexports.HWProvider = HWProvider;","map":null,"metadata":{},"sourceType":"script"}