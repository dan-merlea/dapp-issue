{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/merlea/Development/Crypto/Krogan/dapp-issue/node_modules/@babel/runtime/helpers/regeneratorRuntime.js\").default;\nvar _classCallCheck = require(\"/Users/merlea/Development/Crypto/Krogan/dapp-issue/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/merlea/Development/Crypto/Krogan/dapp-issue/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ExtensionProvider = void 0;\nvar primitives_1 = require(\"./primitives\");\nvar operation_1 = require(\"./operation\");\nvar errors_1 = require(\"./errors\");\nvar ExtensionProvider = /*#__PURE__*/function () {\n  function ExtensionProvider() {\n    _classCallCheck(this, ExtensionProvider);\n    this.account = {\n      address: \"\"\n    };\n    this.initialized = false;\n    if (ExtensionProvider._instance) {\n      throw new Error(\"Error: Instantiation failed: Use ExtensionProvider.getInstance() instead of new.\");\n    }\n    ExtensionProvider._instance = this;\n  }\n  _createClass(ExtensionProvider, [{\n    key: \"setAddress\",\n    value: function setAddress(address) {\n      this.account.address = address;\n      return ExtensionProvider._instance;\n    }\n  }, {\n    key: \"init\",\n    value: function init() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                if (window && window.elrondWallet) {\n                  this.initialized = true;\n                }\n                return _context.abrupt(\"return\", this.initialized);\n              case 2:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n    }\n  }, {\n    key: \"login\",\n    value: function login() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        var token, data;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (this.initialized) {\n                  _context2.next = 2;\n                  break;\n                }\n                throw new Error(\"Extension provider is not initialised, call init() first\");\n              case 2:\n                token = options.token;\n                data = token ? token : \"\";\n                _context2.next = 6;\n                return this.startBgrMsgChannel(operation_1.Operation.Connect, data);\n              case 6:\n                return _context2.abrupt(\"return\", this.account.address);\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n    }\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n        return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (this.initialized) {\n                  _context3.next = 2;\n                  break;\n                }\n                throw new Error(\"Extension provider is not initialised, call init() first\");\n              case 2:\n                _context3.prev = 2;\n                _context3.next = 5;\n                return this.startBgrMsgChannel(operation_1.Operation.Logout, this.account.address);\n              case 5:\n                this.disconnect();\n                _context3.next = 11;\n                break;\n              case 8:\n                _context3.prev = 8;\n                _context3.t0 = _context3[\"catch\"](2);\n                console.warn(\"Extension origin url is already cleared!\", _context3.t0);\n              case 11:\n                return _context3.abrupt(\"return\", true);\n              case 12:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this, [[2, 8]]);\n      }));\n    }\n  }, {\n    key: \"disconnect\",\n    value: function disconnect() {\n      this.account = {\n        address: \"\"\n      };\n    }\n  }, {\n    key: \"getAddress\",\n    value: function getAddress() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                if (this.initialized) {\n                  _context4.next = 2;\n                  break;\n                }\n                throw new Error(\"Extension provider is not initialised, call init() first\");\n              case 2:\n                return _context4.abrupt(\"return\", this.account ? this.account.address : \"\");\n              case 3:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n    }\n  }, {\n    key: \"isInitialized\",\n    value: function isInitialized() {\n      return this.initialized;\n    }\n    // TODO: In V3, this will not be an async function anymore.\n  }, {\n    key: \"isConnected\",\n    value: function isConnected() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                return _context5.abrupt(\"return\", Boolean(this.account.address));\n              case 1:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n    }\n  }, {\n    key: \"signTransaction\",\n    value: function signTransaction(transaction) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee6() {\n        var signedTransactions;\n        return _regeneratorRuntime().wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                this.ensureConnected();\n                _context6.next = 3;\n                return this.signTransactions([transaction]);\n              case 3:\n                signedTransactions = _context6.sent;\n                if (!(signedTransactions.length != 1)) {\n                  _context6.next = 6;\n                  break;\n                }\n                throw new errors_1.ErrCannotSignSingleTransaction();\n              case 6:\n                return _context6.abrupt(\"return\", signedTransactions[0]);\n              case 7:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n    }\n  }, {\n    key: \"ensureConnected\",\n    value: function ensureConnected() {\n      if (!this.account.address) {\n        throw new errors_1.ErrAccountNotConnected();\n      }\n    }\n  }, {\n    key: \"signTransactions\",\n    value: function signTransactions(transactions) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee7() {\n        var extensionResponse, i, transaction, plainSignedTransaction;\n        return _regeneratorRuntime().wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                this.ensureConnected();\n                _context7.next = 3;\n                return this.startBgrMsgChannel(operation_1.Operation.SignTransactions, {\n                  from: this.account.address,\n                  transactions: transactions.map(function (transaction) {\n                    return transaction.toPlainObject();\n                  })\n                });\n              case 3:\n                extensionResponse = _context7.sent;\n                _context7.prev = 4;\n                for (i = 0; i < transactions.length; i++) {\n                  transaction = transactions[i];\n                  plainSignedTransaction = extensionResponse[i];\n                  transaction.applySignature(new primitives_1.Signature(plainSignedTransaction.signature), new primitives_1.Address(this.account.address));\n                }\n                return _context7.abrupt(\"return\", transactions);\n              case 9:\n                _context7.prev = 9;\n                _context7.t0 = _context7[\"catch\"](4);\n                throw new Error(\"Transaction canceled: \".concat(_context7.t0.message, \".\"));\n              case 12:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this, [[4, 9]]);\n      }));\n    }\n  }, {\n    key: \"signMessage\",\n    value: function signMessage(message) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime().mark(function _callee8() {\n        var data, extensionResponse;\n        return _regeneratorRuntime().wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                this.ensureConnected();\n                data = {\n                  account: this.account.address,\n                  message: message.message.toString()\n                };\n                _context8.next = 4;\n                return this.startBgrMsgChannel(operation_1.Operation.SignMessage, data);\n              case 4:\n                extensionResponse = _context8.sent;\n                message.applySignature(new primitives_1.Signature(extensionResponse.signature), new primitives_1.Address(this.account.address));\n                return _context8.abrupt(\"return\", message);\n              case 7:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n    }\n  }, {\n    key: \"cancelAction\",\n    value: function cancelAction() {\n      return this.startBgrMsgChannel(operation_1.Operation.CancelAction, {});\n    }\n  }, {\n    key: \"startBgrMsgChannel\",\n    value: function startBgrMsgChannel(operation, connectData) {\n      var _this = this;\n      return new Promise(function (resolve) {\n        window.postMessage({\n          target: \"erdw-inpage\",\n          type: operation,\n          data: connectData\n        }, window.origin);\n        var eventHandler = function eventHandler(event) {\n          if (event.isTrusted && event.data.target === \"erdw-contentScript\") {\n            if (event.data.type === \"connectResponse\") {\n              if (event.data.data && Boolean(event.data.data.address)) {\n                _this.account = event.data.data;\n              }\n              window.removeEventListener(\"message\", eventHandler);\n              resolve(event.data.data);\n            } else {\n              window.removeEventListener(\"message\", eventHandler);\n              resolve(event.data.data);\n            }\n          }\n        };\n        window.addEventListener(\"message\", eventHandler, false);\n      });\n    }\n  }], [{\n    key: \"getInstance\",\n    value: function getInstance() {\n      return ExtensionProvider._instance;\n    }\n  }]);\n  return ExtensionProvider;\n}();\nexports.ExtensionProvider = ExtensionProvider;\nExtensionProvider._instance = new ExtensionProvider();","map":{"version":3,"mappings":"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","names":["ExtensionProvider","address","_instance","Error","account","window","elrondWallet","initialized","options","token","data","startBgrMsgChannel","operation_1","Connect","Logout","disconnect","console","warn","Boolean","transaction","ensureConnected","signTransactions","signedTransactions","length","errors_1","transactions","SignTransactions","from","map","toPlainObject","extensionResponse","i","plainSignedTransaction","applySignature","primitives_1","signature","message","toString","SignMessage","CancelAction","operation","connectData","Promise","resolve","postMessage","target","type","origin","eventHandler","event","isTrusted","removeEventListener","addEventListener","exports"],"sourceRoot":"","sources":["../src/extensionProvider.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}