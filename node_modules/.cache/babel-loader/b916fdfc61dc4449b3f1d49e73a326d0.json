{"ast":null,"code":"import _regeneratorRuntime from\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{Keys,Entities}from\"@krogan/common\";import{Client}from\"colyseus.js\";import{useEffect}from\"react\";import{useRoomDispatch}from\"context/room\";import{serverUrl}from\"utils/server\";import{playerManager}from\"managers\";import{useContextRef}from\"hooks/useContextRef\";import{useCoreContext}from\"core\";export var useGameManager=function useGameManager(appManager,gameManager,eventHandler){var _useContextRef=useContextRef(),_useContextRef2=_slicedToArray(_useContextRef,2),_useContextRef2$=_useContextRef2[0],gameRoom=_useContextRef2$.gameRoom,player=_useContextRef2$.player,hud=_useContextRef2$.hud,contextRef=_useContextRef2[1];var _useCoreContext=useCoreContext(),account=_useCoreContext.account,address=_useCoreContext.address;var dispatch=useRoomDispatch();var client=new Client(serverUrl());// LIFECYCLE\nuseEffect(function(){// App & Game Events\neventHandler.on('spaceshipControl',joinRoom);eventHandler.on('spaceshipSelfControl',activateSpaceshipSelfControl);eventHandler.on('largeHexClick',largeHexClick);eventHandler.on('closePopup',closePopup);eventHandler.on('asteroidClick',asteroidClick);eventHandler.on('mineAsteroid',mineAsteroid);return function cleanup(){deinit();};},[]);var deinit=function deinit(){// Colyseus\nif(gameRoom)gameRoom.leave();// App & Game Events\neventHandler.remove('spaceshipControl',joinRoom);eventHandler.remove('spaceshipSelfControl',activateSpaceshipSelfControl);eventHandler.remove('largeHexClick',largeHexClick);eventHandler.remove('closePopup',closePopup);eventHandler.remove('asteroidClick',asteroidClick);eventHandler.remove('mineAsteroid',mineAsteroid);// Inputs\nwindow.document.removeEventListener('keydown',handleKeyDown);window.document.removeEventListener('keyup',handleKeyUp);};var joinRoom=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(spaceship,previous){var _ref2,gameRoom,options,roomName,action;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// avoid connecting to the same spaceship\n_ref2=contextRef.current,gameRoom=_ref2.gameRoom;if(!(previous&&previous.nonce==spaceship.nonce)){_context.next=3;break;}return _context.abrupt(\"return\",console.error(\"Same spaceship\"));case 3:if(!(!player||!account)){_context.next=5;break;}return _context.abrupt(\"return\",console.error(\"Something went wrong with the account!\"));case 5:options={address:address,spaceship:spaceship.nonce};roomName=Entities.CoordinateModel.getRoomName(spaceship.coordinate.x,spaceship.coordinate.y,spaceship.coordinate.z);if((gameRoom===null||gameRoom===void 0?void 0:gameRoom.name)!=roomName){if(gameRoom){console.log('Leaving previous game room');gameRoom.leave(true);}// join the hex room if not there already\nclient.joinOrCreate(roomName,options).then(function(room){dispatch({type:'setGameRoom',gameRoom:room});}).catch(function(err){console.error(err);});}else if(previous){console.log('Switching spaceship inside the same room');action={type:'switch',ts:Date.now(),nonce:previous.nonce,value:{nonce:spaceship.nonce}};sendToServer(action);}gameManager.leaveGameRoom();appManager.startSpaceshipControl();dispatch({type:'setSelectedSpaceship',spaceship:undefined});case 11:case\"end\":return _context.stop();}}},_callee);}));return function joinRoom(_x,_x2){return _ref.apply(this,arguments);};}();useEffect(function(){if(!gameRoom)return;console.log(\"Connected to game room: \".concat(gameRoom.id,\" with playerId: \").concat(gameRoom.sessionId));gameManager.sendToServer=sendToServer;playerManager.playerId=gameRoom.sessionId;gameManager.changeHudSpaceship=changeSpaceship;setupGameRoomEventHandlers();setupUserEventHandlers();},[gameRoom]);useEffect(function(){// Leave the game if spaceship control stopped\nif(!hud.controlledSpaceship&&gameRoom){console.log('Leaving previous game room');gameRoom.leave(true);dispatch({type:'setGameRoom',gameRoom:undefined});}},[hud]);// HANDLERS: EventManager\nvar closePopup=function closePopup(){dispatch({type:'setAsteroid',asteroid:undefined});dispatch({type:'setSelectedPoint',point:undefined});};// Asteroid\nvar asteroidClick=function asteroidClick(value){dispatch({type:'setAsteroid',asteroid:value});};var mineAsteroid=function mineAsteroid(value){dispatch({type:'setAsteroid',asteroid:undefined});gameManager.createAndSendAction('mine',{nonce:value.nonce});};// Large HEX\nvar largeHexClick=function largeHexClick(value){dispatch({type:'setSelectedPoint',point:value});};// Spaceship\nvar activateSpaceshipSelfControl=function activateSpaceshipSelfControl(value){if(value.type=='goto')gameManager.moveToDestination(value.point);dispatch({type:'setSelectedPoint',point:undefined});};// HANDLERS: GameManager\nvar sendToServer=function sendToServer(action){var _ref3=contextRef.current,gameRoom=_ref3.gameRoom;if(!gameRoom)return;gameRoom.send(action.type,action);};var changeSpaceship=function changeSpaceship(spaceship){dispatch({type:'setControlledSpaceship',spaceship:spaceship});// todo: send this to server also if not recently joined\n// useful for quick change of control\n};var setupUserEventHandlers=function setupUserEventHandlers(){// Listen to Game events\nwindow.document.addEventListener('keydown',handleKeyDown);window.document.addEventListener('keyup',handleKeyUp);};var setupGameRoomEventHandlers=function setupGameRoomEventHandlers(){if(!gameRoom)return;console.log(\"[Game][Connected] \".concat(gameRoom.sessionId));// Listen for state changes\ngameRoom.onMessage('broadcast',handleMessage);gameManager.setState(gameRoom.state);};// HANDLERS: Game Events\n// HANDLERS: Colyseus\nvar handleMessage=function handleMessage(message){};// HANDLERS: Inputs\nvar handleKeyDown=function handleKeyDown(event){if(!gameManager)return;var key=event.code;if(Keys.LEFT.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.left=true;}if(Keys.UP.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.up=true;}if(Keys.RIGHT.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.right=true;}if(Keys.DOWN.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.down=true;}};var handleKeyUp=function handleKeyUp(event){if(!gameManager)return;var key=event.code;if(Keys.LEFT.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.left=false;}if(Keys.UP.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.up=false;}if(Keys.RIGHT.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.right=false;}if(Keys.DOWN.includes(key)){event.preventDefault();event.stopPropagation();gameManager.inputs.down=false;}};// METHODS\nvar leave=function leave(){gameRoom===null||gameRoom===void 0?void 0:gameRoom.leave();};return{gameManager:gameManager,leave:leave};};","map":null,"metadata":{},"sourceType":"module"}