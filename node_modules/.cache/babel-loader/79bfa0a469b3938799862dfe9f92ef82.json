{"ast":null,"code":"import _regeneratorRuntime from\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/merlea/Development/Crypto/Krogan/kroganverse-com/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{Constants}from\"@krogan/common\";import{Client}from\"colyseus.js\";import{useEffect}from\"react\";import{useRoomDispatch}from\"context/room\";import{serverUrl}from\"utils/server\";import{playerManager}from'managers';import{useContextRef}from\"hooks/useContextRef\";import{useCoreContext}from\"core\";export var useMapManager=function useMapManager(appManager,mapManager,eventHandler){var _useContextRef=useContextRef(),_useContextRef2=_slicedToArray(_useContextRef,2),_useContextRef2$=_useContextRef2[0],mapRoom=_useContextRef2$.mapRoom,player=_useContextRef2$.player,contextRef=_useContextRef2[1];var _useCoreContext=useCoreContext(),account=_useCoreContext.account,address=_useCoreContext.address;var dispatch=useRoomDispatch();var client=new Client(serverUrl());var timer=null;// LIFECYCLE\nuseEffect(function(){// Start players refresh listeners\nif(timer)return;timer=setInterval(updateRoom,Constants.PLAYERS_REFRESH);return function cleanup(){deinit();};},[]);// Called when assets are loaded\nvar joinMapRoom=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){var options;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!player||!account)){_context.next=2;break;}return _context.abrupt(\"return\",console.error(\"Something went wrong with the account!\"));case 2:options={address:address};client.joinOrCreate(player.team,options).then(function(mapRoom){dispatch({type:'setMapRoom',mapRoom:mapRoom});}).catch(function(err){console.error(err);});case 4:case\"end\":return _context.stop();}}},_callee);}));return function joinMapRoom(){return _ref.apply(this,arguments);};}();useEffect(function(){if(!mapRoom)return;console.log(\"Connected to map: \".concat(mapRoom.id));setupMapRoomHandlers();setupGameHandlers();},[mapRoom]);// HANDLERS: MapManager\nvar sendToServer=function sendToServer(action){if(!mapRoom)return;mapRoom.send(action.type,action);};// HANDLERS: Game Events\nvar setupGameHandlers=function setupGameHandlers(){// Listen to Game events\neventHandler.on('warpInitiate',initiateWarp);eventHandler.on('warpSpaceship',warpSpaceship);eventHandler.on('hexClick',openTileDetails);eventHandler.on('hexExplore',exploreTile);eventHandler.on('back',returnToMap);eventHandler.on('setZoom',setZoom);eventHandler.on('closePopup',closePopup);eventHandler.on('spaceshipClick',openSpaceshipDetails);};var deinit=function deinit(){// Colyseus\nif(mapRoom)mapRoom.leave();// Stop refresh listeners\nif(timer)clearInterval(timer);// Clear game listeners\neventHandler.remove('warpInitiate',warpSpaceship);eventHandler.remove('warpSpaceship',warpSpaceship);eventHandler.remove('hexClick',openTileDetails);eventHandler.remove('hexExplore',exploreTile);eventHandler.remove('back',returnToMap);eventHandler.remove('setZoom',setZoom);eventHandler.remove('spaceshipClick',openSpaceshipDetails);eventHandler.remove('closePopup',closePopup);};var setupMapRoomHandlers=function setupMapRoomHandlers(){if(!mapRoom)return;// Set current player\nplayerManager.playerId=mapRoom.sessionId;dispatch({type:'setPlayerId',playerId:mapRoom.sessionId});mapManager.setState(mapRoom.state);// Listen for state changes\nmapRoom.onMessage('broadcast',handleMessage);};// Spaceship\nvar openSpaceshipDetails=function openSpaceshipDetails(value){dispatch({type:'setSelectedSpaceship',spaceship:value});};var closePopup=function closePopup(){dispatch({type:'setSelectedSpaceship',spaceship:undefined});dispatch({type:'setSelectedTile',tile:undefined});};// Hex & Map\nvar setZoom=function setZoom(value){appManager.setZoomLevel(value);};var returnToMap=function returnToMap(){dispatch({type:'setBackButton',visible:false});mapManager.returnToMap();};// Enter hex\nvar exploreTile=function exploreTile(value){dispatch({type:'setBackButton',visible:true});closePopup();mapManager.exploreTile(value);};// Open menu box for hex details\nvar openTileDetails=function openTileDetails(tile){dispatch({type:'setSelectedTile',tile:tile});};// Warp\nvar initiateWarp=function initiateWarp(value){var _contextRef$current;var hud=(_contextRef$current=contextRef.current)===null||_contextRef$current===void 0?void 0:_contextRef$current.hud;if(!hud)return;if(hud.selectedTile){mapManager.setSelectedSpaceship(value);closePopup();}else if(hud.selectedSpaceship){closePopup();returnToMap();mapManager.setSelectedSpaceship(value);}};var warpSpaceship=function warpSpaceship(value){var _ref2=contextRef.current,hud=_ref2.hud;// In case the warp is for current controller spaceship\n// Reset everything\nif(hud.controlledSpaceship&&hud.controlledSpaceship.nonce==value.nonce){appManager.stopSpaceshipControl();dispatch({type:'setControlledSpaceship',spaceship:undefined});}sendToServer({type:'warp',ts:Date.now(),nonce:value.nonce,value:value});};// HANDLERS: Colyseus\nvar handleMessage=function handleMessage(message){};// METHODS\nvar updateRoom=function updateRoom(){var stats=mapManager.getStats();dispatch({type:'setStats',stats:stats});};var leave=function leave(){mapRoom===null||mapRoom===void 0?void 0:mapRoom.leave();};return{joinMapRoom:joinMapRoom,mapManager:mapManager,leave:leave};};","map":null,"metadata":{},"sourceType":"module"}